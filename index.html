<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <title>üöö Billager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f3f4f6; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px; position: relative; overflow: hidden; }
        .header-bg { position: absolute; inset: 0; opacity: 0.15; background-size: cover; background-position: center; }
        .header-content { position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-upload { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; border: 2px dashed rgba(255,255,255,0.4); }
        .logo-upload img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        .logo-upload input { display: none; }
        .logo-placeholder { font-size: 24px; }
        .header-text h1 { font-size: 24px; margin-bottom: 5px; }
        .header-text p { font-size: 14px; opacity: 0.9; }
        .settings-btn { background: rgba(255,255,255,0.2); border: none; padding: 10px; border-radius: 8px; color: white; cursor: pointer; font-size: 20px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .reset-btn { background: rgba(255,255,255,0.2); border: none; padding: 10px 15px; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; }
        .main-tabs { background: white; display: flex; border-bottom: 1px solid #e5e7eb; overflow-x: auto; }
        .main-tab { flex: 1; padding: 15px 10px; text-align: center; border-bottom: 2px solid transparent; cursor: pointer; white-space: nowrap; font-size: 14px; }
        .main-tab.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        .category-tabs { background: white; display: flex; border-bottom: 1px solid #e5e7eb; overflow-x: auto; }
        .category-tab { flex: 1; padding: 15px 10px; text-align: center; border-bottom: 2px solid transparent; cursor: pointer; white-space: nowrap; font-size: 13px; }
        .category-tab.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        .container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .add-item-box { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .add-item-form { display: flex; gap: 8px; align-items: center; }
        .add-item-input { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .add-item-input-small { width: 70px; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; text-align: center; }
        .add-item-btn { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .delete-item-btn { width: 48px; height: 48px; border: none; border-radius: 8px; cursor: pointer; background: #fee2e2; color: #dc2626; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .item-header { display: flex; align-items: center; gap: 15px; }
        .image-upload { width: 80px; height: 80px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; flex-shrink: 0; font-size: 30px; }
        .image-upload img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        .image-upload input { display: none; }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 16px; margin-bottom: 5px; }
        .item-quantity { font-size: 28px; font-weight: bold; color: #2563eb; }
        .item-quantity.low { color: #dc2626; }
        .item-min { font-size: 12px; color: #6b7280; margin-top: 3px; }
        .controls { display: flex; gap: 8px; }
        .btn { width: 48px; height: 48px; border: none; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .btn-minus { background: #fee2e2; color: #dc2626; }
        .btn-plus { background: #d1fae5; color: #059669; }
        .btn-edit { background: #fef3c7; color: #d97706; }
        .calendar { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-nav { background: #f3f4f6; border: none; border-radius: 8px; width: 40px; height: 40px; font-size: 20px; cursor: pointer; }
        .calendar-title { font-size: 18px; font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .day-label { text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; padding: 8px 0; }
        .day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; cursor: pointer; position: relative; padding: 4px; }
        .day.selected { background: #2563eb; color: white; font-weight: bold; }
        .day.today { background: #dbeafe; color: #2563eb; font-weight: 600; }
        .day:not(.selected):not(.today):hover { background: #f3f4f6; }
        .day-number { line-height: 1; }
        .day-indicator { display: flex; gap: 2px; margin-top: 2px; }
        .day-dot { width: 5px; height: 5px; border-radius: 50%; background: #10b981; }
        .day.selected .day-dot { background: white; }
        .day.today .day-dot { background: #2563eb; }
        .entry { border-left: 4px solid #059669; background: #d1fae5; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; }
        .entry-title { font-weight: 600; margin-bottom: 5px; }
        .entry-detail { font-size: 14px; color: #374151; margin-top: 5px; }
        .copy-success { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #059669; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; z-index: 2000; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .add-btn { background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; width: 100%; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 600; }
        .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .form-textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; min-height: 100px; font-family: inherit; }
        .save-btn { background: #2563eb; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; width: 100%; cursor: pointer; }
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .quantity-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1500; align-items: center; justify-content: center; padding: 20px; }
        .quantity-modal.show { display: flex; }
        .quantity-modal-content { background: white; border-radius: 12px; padding: 20px; width: 100%; max-width: 400px; }
        .quantity-modal-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .quantity-modal-input { width: 100%; padding: 12px; border: 2px solid #2563eb; border-radius: 8px; font-size: 20px; text-align: center; font-weight: bold; }
        .quantity-modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .quantity-modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .quantity-modal-btn.cancel { background: #f3f4f6; color: #374151; }
        .quantity-modal-btn.save { background: #2563eb; color: white; }
        .add-materials-btn { background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .materials-summary { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 12px; margin-top: 10px; }
        .materials-summary-title { font-weight: 600; font-size: 13px; color: #059669; margin-bottom: 8px; }
        .materials-summary-item { font-size: 13px; color: #047857; margin-bottom: 4px; }
        .materials-summary-empty { font-size: 13px; color: #6b7280; font-style: italic; }
        .usage-search { width: 100%; padding: 10px; border: 2px solid #2563eb; border-radius: 8px; font-size: 14px; margin-bottom: 15px; }
        .usage-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; }
        .usage-item-name { flex: 1; font-size: 14px; font-weight: 500; }
        .usage-item-input { width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: center; font-size: 14px; }
        .usage-item-unit { font-size: 12px; color: #6b7280; min-width: 25px; }
        .usage-category-header { font-size: 13px; font-weight: 600; color: #6b7280; margin-top: 15px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .materials-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .materials-modal.show { display: flex; }
        .firebase-status { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 3000; display: none; }
        .firebase-status.show { display: block; }
        .firebase-status.syncing { background: #f59e0b; }
        .firebase-status.synced { background: #10b981; }
        .firebase-status.error { background: #dc2626; }
    </style>
</head>
<body>
    <div class="firebase-status" id="firebaseStatus">üîÑ Synkar...</div>
    
    <div class="header">
        <div class="header-bg" id="headerBg"></div>
        <div class="header-content">
            <div class="header-left">
                <div class="logo-upload" onclick="document.getElementById('logoInput').click()">
                    <div class="logo-placeholder" id="logoPlaceholder">üöö</div>
                    <img id="logoImage" style="display: none;">
                    <input type="file" id="logoInput" accept="image/*">
                </div>
                <div class="header-text">
                    <h1>Billager</h1>
                    <p>Hantera material & arbeten</p>
                </div>
            </div>
            <div>
                <button class="reset-btn" onclick="app.resetData()">üîÑ √Öterst√§ll</button>
            </div>
        </div>
    </div>

    <div class="main-tabs">
        <div class="main-tab active" data-tab="inventory" onclick="app.switchMainTab('inventory')">üì¶ Lager</div>
        <div class="main-tab" data-tab="calendar" onclick="app.switchMainTab('calendar')">üìÖ Kalender</div>
    </div>

    <div id="inventorySection">
        <div class="category-tabs">
            <div class="category-tab active" data-category="refrigerants" onclick="app.switchCategory('refrigerants')">‚ùÑÔ∏è K√∂ldmedier</div>
            <div class="category-tab" data-category="consumables" onclick="app.switchCategory('consumables')">üß∞ F√∂rbrukning</div>
            <div class="category-tab" data-category="spareParts" onclick="app.switchCategory('spareParts')">‚öôÔ∏è Reservdelar</div>
        </div>

        <div class="container">
            <div class="add-item-box">
                <div class="add-item-form">
                    <input type="text" class="add-item-input" id="quickAddName" placeholder="Produktnamn">
                    <input type="number" class="add-item-input-small" id="quickAddQty" placeholder="Antal" value="1" step="0.1">
                    <input type="text" class="add-item-input-small" id="quickAddUnit" placeholder="st" value="st">
                    <button class="add-item-btn" onclick="app.quickAdd()">+ L√§gg till</button>
                </div>
            </div>
            <div id="inventoryList"></div>
        </div>
    </div>

    <div id="calendarSection" style="display: none;">
        <div class="container">
            <div class="calendar">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="app.previousMonth()">‚Äπ</button>
                    <div class="calendar-title" id="calendarTitle"></div>
                    <button class="calendar-nav" onclick="app.nextMonth()">‚Ä∫</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            <button class="add-btn" onclick="app.openEntryForm()">+ Ny arbetsrapport</button>
            <div id="entriesList"></div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Redigera produkt</div>
                <button class="close-btn" onclick="app.closeEditModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Produktnamn</label>
                <input type="text" class="form-input" id="editName">
            </div>
            <div class="form-group">
                <label class="form-label">Enhet (t.ex. kg, st, liter)</label>
                <input type="text" class="form-input" id="editUnit">
            </div>
            <div class="form-group">
                <label class="form-label">Minsta lagerniv√•</label>
                <input type="number" class="form-input" id="editMin" step="0.1">
            </div>
            <div class="form-group">
                <label class="form-label">Ladda upp bild</label>
                <input type="file" class="form-input" id="editImageInput" accept="image/*">
            </div>
            <button class="save-btn" onclick="app.saveEdit()">Spara √§ndringar</button>
        </div>
    </div>

    <div class="quantity-modal" id="quantityModal">
        <div class="quantity-modal-content">
            <div class="quantity-modal-title">√Ñndra antal</div>
            <input type="number" class="quantity-modal-input" id="quantityInput" step="0.1">
            <div class="quantity-modal-buttons">
                <button class="quantity-modal-btn cancel" onclick="app.closeQuantityModal()">Avbryt</button>
                <button class="quantity-modal-btn save" onclick="app.saveQuantity()">Spara</button>
            </div>
        </div>
    </div>

    <div class="modal" id="entryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="entryModalTitle">Ny arbetsrapport</div>
                <button class="close-btn" onclick="app.closeEntryForm()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Titel/Uppdrag</label>
                <input type="text" class="form-input" id="entryTitle" placeholder="T.ex. Service v√§rmepump">
            </div>
            <div class="form-group">
                <label class="form-label">Plats/Adress</label>
                <input type="text" class="form-input" id="entryLocation" placeholder="T.ex. Kungsgatan 12, G√∂teborg">
            </div>
            <div class="form-group">
                <label class="form-label">Starttid</label>
                <input type="time" class="form-input" id="entryStartTime">
            </div>
            <div class="form-group">
                <label class="form-label">Sluttid</label>
                <input type="time" class="form-input" id="entryEndTime">
            </div>
            <div class="form-group">
                <label class="form-label">Beskrivning/√Ötg√§rder</label>
                <textarea class="form-textarea" id="entryDescription" placeholder="Beskriv vad som gjordes..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Bilder</label>
                <input type="file" class="form-input" id="entryImageInput" accept="image/*" multiple>
            </div>
            
            <button class="add-materials-btn" onclick="app.openMaterialsModal()">
                üì¶ L√§gg till f√∂rbrukat material
            </button>
            
            <div class="materials-summary" id="materialsSummary">
                <div class="materials-summary-title">F√∂rbrukat material:</div>
                <div id="materialsSummaryContent" class="materials-summary-empty">Inget material tillagt √§nnu</div>
            </div>
            
            <button class="save-btn" onclick="app.saveEntry()">Spara arbetsrapport</button>
        </div>
    </div>

    <div class="materials-modal" id="materialsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">V√§lj f√∂rbrukat material</div>
                <button class="close-btn" onclick="app.closeMaterialsModal()">&times;</button>
            </div>
            <input type="text" class="usage-search" id="usageSearch" placeholder="üîç S√∂k produkt...">
            <div id="usageItemsList"></div>
            <button class="save-btn" onclick="app.saveMaterialsUsage()">Klar</button>
        </div>
    </div>

    <div id="copySuccess" class="copy-success" style="display: none;">‚úì Material uppdaterat!</div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCZjOBDcyyLMQZDeQPKK0bpdRSh3prLs0M",
            authDomain: "patrikapps-cd169.firebaseapp.com",
            databaseURL: "https://patrikapps-cd169-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "patrikapps-cd169",
            storageBucket: "patrikapps-cd169.firebasestorage.app",
            messagingSenderId: "334803684499",
            appId: "1:334803684499:web:13c0f00c357ad5c97ed166"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const database = getDatabase(firebaseApp);
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        
        console.log('‚úÖ Firebase initialiserad');
    </script>

    <script>
        const app = {
            inventory: {
                refrigerants: [
                    { id: 1, name: 'R32', quantity: 25, unit: 'kg', minQuantity: 10, image: null },
                    { id: 2, name: 'R410A', quantity: 30, unit: 'kg', minQuantity: 15, image: null },
                    { id: 3, name: 'R134a', quantity: 20, unit: 'kg', minQuantity: 10, image: null }
                ],
                consumables: [
                    { id: 4, name: 'Handskar', quantity: 50, unit: 'st', minQuantity: 20, image: null },
                    { id: 5, name: 'Skruvdragare T20', quantity: 3, unit: 'st', minQuantity: 1, image: null },
                    { id: 6, name: 'Kabelband', quantity: 200, unit: 'st', minQuantity: 50, image: null }
                ],
                spareParts: [
                    { id: 7, name: 'Kompressor 2HP', quantity: 2, unit: 'st', minQuantity: 1, image: null },
                    { id: 8, name: 'Fl√§kt 12V', quantity: 5, unit: 'st', minQuantity: 2, image: null },
                    { id: 9, name: 'Termostat', quantity: 8, unit: 'st', minQuantity: 3, image: null }
                ]
            },
            currentCategory: 'refrigerants',
            currentMainTab: 'inventory',
            currentEditItem: null,
            currentEditCategory: null,
            currentQuantityItem: null,
            currentQuantityCategory: null,
            calendarEntries: [],
            currentMonth: new Date(),
            selectedDate: new Date(),
            entryImages: [],
            currentEditEntry: null,
            currentEntryUsage: {},
            logo: null,
            headerBg: null,

            init: function() {
                this.loadData();
                this.setupLogoUpload();
                this.setupImageInputs();
                this.render();
                this.renderCalendar();
                this.renderEntries();
            },

            loadData: async function() {
                const statusEl = document.getElementById('firebaseStatus');
                statusEl.textContent = 'üîÑ Laddar data...';
                statusEl.className = 'firebase-status show syncing';
                
                try {
                    const inventorySnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'billager/inventory'));
                    const calendarSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDB, 'billager/calendar'));
                    
                    if (inventorySnapshot.exists()) {
                        this.inventory = inventorySnapshot.val();
                    }
                    
                    if (calendarSnapshot.exists()) {
                        this.calendarEntries = calendarSnapshot.val() || [];
                    }
                    
                    statusEl.textContent = '‚úì Synkad';
                    statusEl.className = 'firebase-status show synced';
                    setTimeout(() => statusEl.classList.remove('show'), 2000);
                    
                    this.render();
                    this.renderCalendar();
                    this.renderEntries();
                } catch (error) {
                    console.error('Firebase load error:', error);
                    statusEl.textContent = '‚úó Fel vid laddning';
                    statusEl.className = 'firebase-status show error';
                    setTimeout(() => statusEl.classList.remove('show'), 3000);
                }
            },

            saveData: async function() {
                const statusEl = document.getElementById('firebaseStatus');
                statusEl.textContent = 'üîÑ Sparar...';
                statusEl.className = 'firebase-status show syncing';
                
                try {
                    await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'billager/inventory'), this.inventory);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'billager/calendar'), this.calendarEntries);
                    
                    statusEl.textContent = '‚úì Sparat';
                    statusEl.className = 'firebase-status show synced';
                    setTimeout(() => statusEl.classList.remove('show'), 2000);
                } catch (error) {
                    console.error('Firebase save error:', error);
                    statusEl.textContent = '‚úó Fel vid sparning';
                    statusEl.className = 'firebase-status show error';
                    setTimeout(() => statusEl.classList.remove('show'), 3000);
                }
            },

            setupLogoUpload: function() {
                const logoInput = document.getElementById('logoInput');
                logoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            this.logo = event.target.result;
                            document.getElementById('logoImage').src = this.logo;
                            document.getElementById('logoImage').style.display = 'block';
                            document.getElementById('logoPlaceholder').style.display = 'none';
                            this.saveData();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            },

            setupImageInputs: function() {
                document.querySelectorAll('.image-upload').forEach(upload => {
                    upload.addEventListener('click', function() {
                        this.querySelector('input').click();
                    });
                });
            },

            switchMainTab: function(tab) {
                this.currentMainTab = tab;
                document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                
                if (tab === 'inventory') {
                    document.getElementById('inventorySection').style.display = 'block';
                    document.getElementById('calendarSection').style.display = 'none';
                } else {
                    document.getElementById('inventorySection').style.display = 'none';
                    document.getElementById('calendarSection').style.display = 'block';
                    this.renderCalendar();
                    this.renderEntries();
                }
            },

            switchCategory: function(category) {
                this.currentCategory = category;
                document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector(`[data-category="${category}"]`).classList.add('active');
                this.render();
            },

            quickAdd: function() {
                const name = document.getElementById('quickAddName').value.trim();
                const qty = parseFloat(document.getElementById('quickAddQty').value) || 1;
                const unit = document.getElementById('quickAddUnit').value.trim() || 'st';
                
                if (!name) {
                    alert('Ange ett produktnamn');
                    return;
                }
                
                const newItem = {
                    id: Date.now(),
                    name: name,
                    quantity: qty,
                    unit: unit,
                    minQuantity: 1,
                    image: null
                };
                
                this.inventory[this.currentCategory].push(newItem);
                this.saveData();
                this.render();
                
                document.getElementById('quickAddName').value = '';
                document.getElementById('quickAddQty').value = '1';
            },

            deleteItem: function(id) {
                if (confirm('√Ñr du s√§ker p√• att du vill ta bort denna produkt?')) {
                    this.inventory[this.currentCategory] = this.inventory[this.currentCategory].filter(item => item.id !== id);
                    this.saveData();
                    this.render();
                }
            },

            openQuantityModal: function(id, category) {
                const item = this.inventory[category].find(i => i.id === id);
                if (!item) return;
                
                this.currentQuantityItem = id;
                this.currentQuantityCategory = category;
                
                document.getElementById('quantityInput').value = item.quantity;
                document.getElementById('quantityModal').classList.add('show');
                document.getElementById('quantityInput').focus();
                document.getElementById('quantityInput').select();
            },

            closeQuantityModal: function() {
                document.getElementById('quantityModal').classList.remove('show');
                this.currentQuantityItem = null;
                this.currentQuantityCategory = null;
            },

            saveQuantity: function() {
                const newQty = parseFloat(document.getElementById('quantityInput').value);
                if (isNaN(newQty) || newQty < 0) {
                    alert('Ange ett giltigt antal');
                    return;
                }
                
                const item = this.inventory[this.currentQuantityCategory].find(i => i.id === this.currentQuantityItem);
                if (item) {
                    item.quantity = Number(newQty.toFixed(2));
                    this.saveData();
                    this.render();
                }
                
                this.closeQuantityModal();
            },

            adjustQuantity: function(id, category, delta) {
                const item = this.inventory[category].find(i => i.id === id);
                if (item) {
                    item.quantity = Math.max(0, Number((item.quantity + delta).toFixed(2)));
                    this.saveData();
                    this.render();
                }
            },

            openEditModal: function(id, category) {
                const item = this.inventory[category].find(i => i.id === id);
                if (!item) return;
                
                this.currentEditItem = id;
                this.currentEditCategory = category;
                
                document.getElementById('editName').value = item.name;
                document.getElementById('editUnit').value = item.unit;
                document.getElementById('editMin').value = item.minQuantity;
                
                document.getElementById('editModal').classList.add('show');
            },

            closeEditModal: function() {
                document.getElementById('editModal').classList.remove('show');
                this.currentEditItem = null;
                this.currentEditCategory = null;
            },

            saveEdit: function() {
                const item = this.inventory[this.currentEditCategory].find(i => i.id === this.currentEditItem);
                if (!item) return;
                
                item.name = document.getElementById('editName').value.trim();
                item.unit = document.getElementById('editUnit').value.trim();
                item.minQuantity = parseFloat(document.getElementById('editMin').value) || 0;
                
                const imageFile = document.getElementById('editImageInput').files[0];
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        item.image = e.target.result;
                        this.saveData();
                        this.render();
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    this.saveData();
                    this.render();
                }
                
                this.closeEditModal();
            },

            uploadItemImage: function(id, category, file) {
                const item = this.inventory[category].find(i => i.id === id);
                if (!item || !file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    item.image = e.target.result;
                    this.saveData();
                    this.render();
                };
                reader.readAsDataURL(file);
            },

            render: function() {
                const items = this.inventory[this.currentCategory];
                const container = document.getElementById('inventoryList');
                
                if (items.length === 0) {
                    container.innerHTML = '<div class="empty-state">Inga produkter √§n. L√§gg till din f√∂rsta produkt ovan!</div>';
                    return;
                }
                
                container.innerHTML = items.map(item => `
                    <div class="item">
                        <div class="item-header">
                            <div class="image-upload" onclick="document.getElementById('img-${item.id}').click()">
                                ${item.image ? `<img src="${item.image}">` : '<div style="font-size: 30px;">üì¶</div>'}
                                <input type="file" id="img-${item.id}" accept="image/*" onchange="app.uploadItemImage(${item.id}, '${this.currentCategory}', this.files[0])">
                            </div>
                            <div class="item-info">
                                <div class="item-name">${item.name}</div>
                                <div class="item-quantity ${item.quantity <= item.minQuantity ? 'low' : ''}" onclick="app.openQuantityModal(${item.id}, '${this.currentCategory}')">
                                    ${item.quantity} ${item.unit}
                                </div>
                                <div class="item-min">Min: ${item.minQuantity} ${item.unit}</div>
                            </div>
                            <div class="controls">
                                <button class="btn btn-minus" onclick="app.adjustQuantity(${item.id}, '${this.currentCategory}', -1)">-</button>
                                <button class="btn btn-plus" onclick="app.adjustQuantity(${item.id}, '${this.currentCategory}', 1)">+</button>
                                <button class="btn btn-edit" onclick="app.openEditModal(${item.id}, '${this.currentCategory}')">‚úèÔ∏è</button>
                                <button class="delete-item-btn" onclick="app.deleteItem(${item.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderCalendar: function() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                
                const monthNames = ['Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni', 
                                   'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'];
                document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                
                const dayLabels = ['M√•n', 'Tis', 'Ons', 'Tor', 'Fre', 'L√∂r', 'S√∂n'];
                let html = dayLabels.map(label => `<div class="day-label">${label}</div>`).join('');
                
                const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
                for (let i = 0; i < adjustedFirstDay; i++) {
                    html += '<div class="day"></div>';
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = dateStr === today.toISOString().split('T')[0];
                    const isSelected = dateStr === this.selectedDate.toISOString().split('T')[0];
                    const hasEntry = this.calendarEntries.some(e => e.date === dateStr);
                    
                    const classes = ['day'];
                    if (isToday) classes.push('today');
                    if (isSelected) classes.push('selected');
                    
                    html += `
                        <div class="${classes.join(' ')}" onclick="app.selectDate(${year}, ${month}, ${day})">
                            <div class="day-number">${day}</div>
                            ${hasEntry ? '<div class="day-indicator"><div class="day-dot"></div></div>' : ''}
                        </div>
                    `;
                }
                
                document.getElementById('calendarGrid').innerHTML = html;
            },

            selectDate: function(year, month, day) {
                this.selectedDate = new Date(year, month, day);
                this.renderCalendar();
                this.renderEntries();
            },

            previousMonth: function() {
                this.currentMonth = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth() - 1);
                this.renderCalendar();
            },

            nextMonth: function() {
                this.currentMonth = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth() + 1);
                this.renderCalendar();
            },

            openEntryForm: function() {
                this.currentEditEntry = null;
                this.entryImages = [];
                this.currentEntryUsage = {};
                document.getElementById('entryModalTitle').textContent = 'Ny arbetsrapport';
                document.getElementById('entryTitle').value = '';
                document.getElementById('entryLocation').value = '';
                document.getElementById('entryStartTime').value = '';
                document.getElementById('entryEndTime').value = '';
                document.getElementById('entryDescription').value = '';
                document.getElementById('entryImageInput').value = '';
                this.updateMaterialsSummary();
                document.getElementById('entryModal').classList.add('show');
            },

            openMaterialsModal: function() {
                this.renderUsageItems();
                document.getElementById('materialsModal').classList.add('show');
            },

            closeMaterialsModal: function() {
                document.getElementById('materialsModal').classList.remove('show');
            },

            renderUsageItems: function() {
                const search = document.getElementById('usageSearch').value.toLowerCase();
                const allCategories = {
                    'refrigerants': '‚ùÑÔ∏è K√∂ldmedier',
                    'consumables': 'üß∞ F√∂rbrukning',
                    'spareParts': '‚öôÔ∏è Reservdelar'
                };
                
                let html = '';
                
                Object.entries(allCategories).forEach(([category, categoryName]) => {
                    const items = this.inventory[category].filter(item => 
                        item.name.toLowerCase().includes(search)
                    );
                    
                    if (items.length > 0) {
                        html += `<div class="usage-category-header">${categoryName}</div>`;
                        items.forEach(item => {
                            const currentValue = this.currentEntryUsage[item.id] || 0;
                            html += `
                                <div class="usage-item">
                                    <div class="usage-item-name">${item.name}</div>
                                    <input type="number" class="usage-item-input" 
                                           value="${currentValue}" 
                                           step="0.1" 
                                           min="0"
                                           onchange="app.updateUsage(${item.id}, this.value)">
                                    <div class="usage-item-unit">${item.unit}</div>
                                </div>
                            `;
                        });
                    }
                });
                
                document.getElementById('usageItemsList').innerHTML = html;
                
                document.getElementById('usageSearch').oninput = () => this.renderUsageItems();
            },

            updateUsage: function(itemId, value) {
                const qty = parseFloat(value);
                if (qty > 0) {
                    this.currentEntryUsage[itemId] = qty;
                } else {
                    delete this.currentEntryUsage[itemId];
                }
            },

            saveMaterialsUsage: function() {
                this.updateMaterialsSummary();
                this.closeMaterialsModal();
            },

            updateMaterialsSummary: function() {
                const usedItems = [];
                const allCategories = ['refrigerants', 'consumables', 'spareParts'];
                
                allCategories.forEach(category => {
                    this.inventory[category].forEach(item => {
                        if (this.currentEntryUsage[item.id]) {
                            usedItems.push({
                                name: item.name,
                                quantity: this.currentEntryUsage[item.id],
                                unit: item.unit
                            });
                        }
                    });
                });
                
                const summaryEl = document.getElementById('materialsSummaryContent');
                if (usedItems.length === 0) {
                    summaryEl.className = 'materials-summary-empty';
                    summaryEl.textContent = 'Inget material tillagt √§nnu';
                } else {
                    summaryEl.className = '';
                    summaryEl.innerHTML = usedItems.map(item => 
                        `<div class="materials-summary-item">‚Ä¢ ${item.quantity} ${item.unit} ${item.name}</div>`
                    ).join('');
                }
            },

            closeEntryForm: function() {
                document.getElementById('entryModal').classList.remove('show');
            },

            renderEntries: function() {
                const dateStr = this.selectedDate.toISOString().split('T')[0];
                const entries = this.calendarEntries.filter(e => e.date === dateStr);
                
                const container = document.getElementById('entriesList');
                
                if (entries.length === 0) {
                    container.innerHTML = '<div class="empty-state">Inga arbetsrapporter f√∂r detta datum</div>';
                    return;
                }
                
                container.innerHTML = entries.map(entry => {
                    let materialsHtml = '';
                    if (entry.usedItems && entry.usedItems.length > 0) {
                        materialsHtml = '<div class="entry-detail"><strong>F√∂rbrukat material:</strong><br>' +
                            entry.usedItems.map(item => `‚Ä¢ ${item.quantity} ${item.unit} ${item.name}`).join('<br>') +
                            '</div>';
                    }
                    
                    return `
                        <div class="entry">
                            <div class="entry-title">${entry.title}</div>
                            ${entry.location ? `<div class="entry-detail">üìç ${entry.location}</div>` : ''}
                            ${entry.startTime ? `<div class="entry-detail">‚è∞ ${entry.startTime}${entry.endTime ? ' - ' + entry.endTime : ''}</div>` : ''}
                            ${entry.description ? `<div class="entry-detail">${entry.description}</div>` : ''}
                            ${materialsHtml}
                            ${entry.images && entry.images.length > 0 ? `
                                <div class="entry-detail" style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                                    ${entry.images.map(img => `<img src="${img}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            showCopySuccess: function() {
                const el = document.getElementById('copySuccess');
                el.style.display = 'block';
                setTimeout(() => {
                    el.style.display = 'none';
                }, 2000);
            },

            saveEntry: function() {
                const title = document.getElementById('entryTitle').value.trim();
                if (!title) {
                    alert('Ange en titel f√∂r arbetsrapporten');
                    return;
                }
                
                const usedItems = [];
                const allCategories = ['refrigerants', 'consumables', 'spareParts'];
                
                if (this.currentEditEntry) {
                    const oldEntry = this.calendarEntries.find(e => e.id === this.currentEditEntry);
                    if (oldEntry && oldEntry.usedItems) {
                        oldEntry.usedItems.forEach(item => {
                            const invItem = this.findInventoryItem(item.id);
                            if (invItem) {
                                invItem.quantity = Number((invItem.quantity + item.quantity).toFixed(2));
                            }
                        });
                    }
                }
                
                allCategories.forEach(category => {
                    this.inventory[category].forEach(item => {
                        if (this.currentEntryUsage[item.id]) {
                            const usedQty = this.currentEntryUsage[item.id];
                            
                            if (usedQty > item.quantity) {
                                alert(`Varning: Du f√∂rs√∂ker anv√§nda ${usedQty} ${item.unit} av ${item.name}, men du har bara ${item.quantity} ${item.unit} i lager.`);
                            }
                            
                            item.quantity = Math.max(0, Number((item.quantity - usedQty).toFixed(2)));
                            
                            usedItems.push({
                                id: item.id,
                                name: item.name,
                                quantity: usedQty,
                                unit: item.unit,
                                category: category
                            });
                        }
                    });
                });
                
                const imageFiles = document.getElementById('entryImageInput').files;
                const imagePromises = [];
                
                for (let file of imageFiles) {
                    imagePromises.push(new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    }));
                }
                
                Promise.all(imagePromises).then(images => {
                    const entryData = {
                        date: this.selectedDate.toISOString().split('T')[0],
                        title: title,
                        location: document.getElementById('entryLocation').value,
                        startTime: document.getElementById('entryStartTime').value,
                        endTime: document.getElementById('entryEndTime').value,
                        description: document.getElementById('entryDescription').value,
                        images: images,
                        usedItems: usedItems
                    };
                    
                    if (this.currentEditEntry) {
                        const index = this.calendarEntries.findIndex(e => e.id === this.currentEditEntry);
                        if (index !== -1) {
                            this.calendarEntries[index] = { ...this.calendarEntries[index], ...entryData };
                        }
                    } else {
                        entryData.id = Date.now();
                        this.calendarEntries.push(entryData);
                    }
                    
                    this.saveData();
                    this.closeEntryForm();
                    this.renderEntries();
                    
                    if (usedItems.length > 0) {
                        setTimeout(() => {
                            this.showCopySuccess();
                        }, 100);
                    }
                });
            },

            findInventoryItem: function(id) {
                const allCategories = ['refrigerants', 'consumables', 'spareParts'];
                for (let category of allCategories) {
                    const item = this.inventory[category].find(i => i.id === id);
                    if (item) return item;
                }
                return null;
            },

            resetData: function() {
                if (confirm('Vill du √•terst√§lla alla produkter till standard? Detta tar bort allt lager och alla bilder!')) {
                    window.firebaseSet(window.firebaseRef(window.firebaseDB, 'billager'), null).then(() => {
                        location.reload();
                    });
                }
            }
        };

        // V√§nta p√• att Firebase SDK laddas
        const checkFirebase = setInterval(() => {
            if (window.firebaseDB) {
                clearInterval(checkFirebase);
                app.init();
            }
        }, 100);
        
        // PWA Service Worker registrering
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('‚úÖ Service Worker registrerad');
                }).catch(err => {
                    console.log('Service Worker registrering misslyckades:', err);
                });
            });
        }
    </script>
</body>
</html>
